<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>User Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <span class="navbar-text text-white" id="userInfo">
            User Panel
        </span>
        <form th:action="@{/logout}" method="post" class="d-inline">
            <button class="btn btn-outline-light btn-sm">Logout</button>
        </form>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-2 px-0 bg-light border-end" style="height: 100vh;">
            <ul class="nav flex-column nav-pills mt-3" id="sidebarMenu">
                <li class="nav-item">
                    <a class="nav-link active" href="/user">User</a>
                </li>
                <!-- Admin ссылка будет добавлена если есть роль -->
            </ul>
        </div>

        <div class="col-10 px-4 mt-4">
            <h2>User Panel</h2>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Your Information</h5>
                </div>
                <div class="card-body">
                    <div id="userData">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Загрузка данных пользователя
    async function loadUserData() {
        try {
            const response = await fetch('/api/auth/current-user');
            if (!response.ok) return;

            const user = await response.json();
            displayUserData(user);
            updateSidebar(user);
        } catch (error) {
            console.log('Error loading user data');
        }
    }

    // Отображение данных
    function displayUserData(user) {
        const div = document.getElementById('userData');
        let html = '';

        if (user.username) {
            html = `
                <p><strong>Username:</strong> ${user.username}</p>
                <p><strong>Email:</strong> ${user.email || 'Not specified'}</p>
                <p><strong>Age:</strong> ${user.age || 'Not specified'}</p>
            `;
        } else if (user.authorities) {
            const roles = user.authorities.map(a => a.authority).join(', ');
            html = `
                <p><strong>Username:</strong> ${user.username || 'User'}</p>
                <p><strong>Roles:</strong> ${roles}</p>
            `;
        }

        div.innerHTML = html;
    }

    // Обновление sidebar
    function updateSidebar(user) {
        const sidebar = document.getElementById('sidebarMenu');

        // Проверяем есть ли роль ADMIN
        const hasAdmin = user.roles?.some(r => r.name.includes('ADMIN')) ||
            user.authorities?.some(a => a.authority.includes('ADMIN'));

        if (hasAdmin) {
            const adminItem = document.createElement('li');
            adminItem.className = 'nav-item';
            adminItem.innerHTML = '<a class="nav-link" href="/admin">Admin</a>';
            sidebar.appendChild(adminItem);
        }
    }

    // Загрузка при старте
    document.addEventListener('DOMContentLoaded', loadUserData);
</script>

</body>
</html>